on: push

permissions:
  contents: write

jobs:
  cpe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout NVD repo
        uses: actions/checkout@v2
        with:
          ref: release

      - name: Checkout Fleet
        uses: actions/checkout@v2
        with:
          repository: fleetdm/fleet
          fetch-depth: 1
          ref: main
          token: ${{ github.token }}
          path: fleet

      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: '^1.17.3'

      - name: Generate CPE database
        run: |
          cd fleet
          go mod download
          go run -tags fts5 cmd/cpe/generate.go
          cat ./etagenv >> $GITHUB_ENV
